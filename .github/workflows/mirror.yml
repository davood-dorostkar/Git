name: Mirror to hamgit (SSH)

on:
  push:
    branches:
      - '**'

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.GITLAB_SSH_PRIVATE_KEY }}

      - name: Configure SSH to Trust GitLab
        run: |
          mkdir -p ~/.ssh
          # Get GitLab's SSH fingerprint and add to known_hosts
          ssh-keyscan -H hamgit.ir >> ~/.ssh/known_hosts
          
          # Verify it was added
          echo "=== GitLab's SSH key fingerprint ==="
          ssh-keyscan hamgit.ir | ssh-keygen -lf -
          
          echo "=== known_hosts content ==="
          cat ~/.ssh/known_hosts | grep hamgit

      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection to GitLab..."
          ssh -T git@hamgit.ir 2>&1 | head -5
          # Should show: "Welcome to GitLab, @username!"

      - name: Configure Git
        run: |
          git config user.name "Davood Dorostkar"
          git config user.email "davood.dorostkar.ut@gmail.com"

      - name: Setup GitLab Remote
        run: |
          # Clean up any existing remote
          git remote remove hamgit 2>/dev/null || true
          
          # Get your GitLab username/group
          # Replace "YOUR_GITLAB_USERNAME" with your actual GitLab username
          GITLAB_USER="davood-dorostkar"
          REPO_NAME="${{ github.event.repository.name }}"
          
          # Add remote (notice I'm using your remote name "hamgit")
          git remote add hamgit git@hamgit.ir:${GITLAB_USER}/${REPO_NAME}.git
          
          echo "Remote added:"
          git remote -v

      - name: Push to GitLab
        run: |
          echo "Pushing to GitLab..."
          
          # Try with verbose output
          GIT_SSH_COMMAND="ssh -v" git push --all hamgit 2>&1 | tail -20 || {
            echo "First push failed, trying with --force"
            git push --all hamgit --force
          }
          
          # Push tags if on main/master
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "master" ]]; then
            echo "Pushing tags from $BRANCH_NAME branch"
            git push --tags hamgit || git push --tags hamgit --force
          fi